<!DOCTYPE html>
<html>
<head>
	<title>Twitch Stats | Home</title>
	<link rel="stylesheet" type="text/css" href="/styles/style.css">
	<style>
		#word-counter {
			text-align: center;
		}
		#word-counter #num {
			font-size: 18px;
		}
</style>
<script src="/socket.io/socket.io.js"></script>
<script src="/js/jquery.min.js"></script>
<script>
	// Create Socket.IO object
	var socket = io();

	// Declare how many words are supposed to show up in the common words table
	var maxWords = 10;

	// Declare how long common words are supposed to be stored (in ms)
	var maxWordAge = 60000;

	// Set the update time for the table (in ms)
	var updateTime = 1000;

	// Create array to temporarily store words from chat messages
	var recentWords = [];
</script>
</head>
<body>
	<nav>
		<div class="center container">
			<h1 id="logo">Twitch Stats</h1>
			<div id="subtitle">Chat Statistics and Visualisations</div>
		</div>
	</nav>
	<main>
		<div class="center container">
			<form id="channel-picker" action="">
				<input id="channel" placeholder="Channel">
				<button>Pick</button>
				<div id="status">Connected</div>
			</form>
		</div>
		<div id="keyword-picker" class="center container">
			<span>Keyword: </span><input id="keyword" onchange="resetCounter()" value="VAC">
		</div>
		<div id="word-counter" class="center container">
			<h2>Counter</h2>
			<p id="count">0</p>
			<span id="count-unit">words</span><br>
			<button id="count-reset" type="button" onclick="resetCounter()">Reset</button>
		</div>
		<div id="word-freq" class="center container">
			<h2>Frequency</h2>
			<p id="freq">0</p>
			<span id="freq-unit">words/sec</span>
		</div>
		<div id="common-words" class="center container">
			<h2>Common words</h2>
			<p>The most used words in the past 60 seconds<p>
			<table id="common-words-table" class="center">
				<thead>
					<tr><th>Word</th><th>Count</th></tr>
				</thead>
				<tbody>
				</tbody>
			</table>
		</div>
		<div class="center container">
			<canvas id="testChart" height="400" width="400"></canvas>
		</div>
	</main>
	<script>
		// Set the word counter to 0
		function resetCounter(){
			$('#count').html(0);
			oldCount = 0; // Keeps frequency from going wild
		}

		// Clears table, adding rows until there are at least numRows in its tbody
		function clearTable(numRows){
			// Get tbody element
			var tbody = $('#common-words-table tbody');

			// Add rows until there are at least numRows
			while(tbody.children('tr').length < numRows){
				tbody.append('<tr><td></td><td></td></tr>');
			}

			// Empty all table data cells
			tbody.find('td').text('-');
		}

		// Add words to recentWords array, together with the time they were added
		function addWords(words){
			// Get current time
			var date = new Date();
			var now = date.getTime();

			for(i = 0; i < words.length; i++){
				// Check if word is already in recentWords
				var found = false;
				for(j = 0; j < recentWords.length; j++){
					// If word is already in recentWords, only add the current time to the existing entry
					if(recentWords[j].word == words[i]){
						found = true;
						recentWords[j].times.push(now);
						recentWords[j].count = recentWords[j].times.length; // Updates count, may be obsolete
						break;
					}
				}
				if(!found){
					// Add the new word to recentWords
					recentWords.push({
						word: words[i],
						times: [now],
						count: 1
					});
				}
			}
		}

		// Ask server to change channel when submit button is clicked
		$('#channel-picker').submit(function(){
			resetCounter();
			socket.emit('channelChange', $('#channel').val());
			return false; // Avoids reloading the page
		});

		// Receive feeback when we connect to the channel
		socket.on('channelChangeSuccess', function(){
			$('#status').css('opacity', '1');
			$('#status').animate({ opacity: 0 }, 1500);
		});

		// Catch messages from selected channel
		socket.on('chatMessage', function(from, to, message){
			console.log(message);

			// Split message up into individual words
			var words = message.split(' ');
			
			// Add words from message to recentWords
			addWords(words);

			// Increment keyword counter if word matches
			for(i = 0; i < words.length; i++){
				if(words[i].toLowerCase() == $('#keyword').val().toLowerCase()){
					var count = parseInt($('#count').html());
					$('#count').html(count + 1);
				}
			}
		});

		// Every updateTime, display the maxWords most common words and their count in the table
		setInterval(function(){
			// Remove all data from table
			clearTable();

			// Sort recent words by count
			sortedWords = recentWords;
			sortedWords.sort(function(a, b){
				return b.count - a.count;
			})

			// Get the tbody element
			var tbody = $('#common-words-table tbody');

			// Add the maxWords most common words and their count to the table
			// Don't try to add more words than there are in recentWords
			for(i = 0; i < maxWords && i < sortedWords.length; i++){
				tbody.children('tr').eq(i).children('td').eq(0).text(sortedWords[i].word);
				tbody.children('tr').eq(i).children('td').eq(1).text(sortedWords[i].count);
			}
		}, updateTime);

		// Every updateTime, remove word times that are over maxWordAge old
		setInterval(function(){
			// Get current time
			var date = new Date();
			var now = date.getTime();

			// Remove word times if they are over maxWordAge old
			for(i = 0; i < recentWords.length; i++){
				while(now - recentWords[i].times[0] > maxWordAge){
					recentWords[i].times.shift();
				}
				recentWords[i].count = recentWords[i].times.length; // Update count after removing old times
				// If word count is 0, remove it from recentWords
				if(recentWords[i].count == 0){
					recentWords.splice(i, 1);
				}
			}
		}, updateTime);

		// Every second, calculate the frequency of the keyword
		var oldCount = 0;
		var newCount;
		var dt = 1000;
		setInterval(function(){
			newCount = $("#count").html();
			dCount = newCount - oldCount;
			freq = dCount / dt * 1000; // In words/s
			$('#freq').html(freq);
			oldCount = newCount;
		}, dt);

		// Fill table to have space for 10 words
		clearTable(maxWords);

		var ctx = $("#testChart");
		var chart = new Chart(ctx, {
		    type: 'bar',
		    data: {
		        labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
		        datasets: [{
		            label: '# of Votes',
		            data: [12, 19, 3, 5, 2, 3],
		            backgroundColor: [
		                'rgba(255, 99, 132, 0.2)',
		                'rgba(54, 162, 235, 0.2)',
		                'rgba(255, 206, 86, 0.2)',
		                'rgba(75, 192, 192, 0.2)',
		                'rgba(153, 102, 255, 0.2)',
		                'rgba(255, 159, 64, 0.2)'
		            ],
		            borderColor: [
		                'rgba(255,99,132,1)',
		                'rgba(54, 162, 235, 1)',
		                'rgba(255, 206, 86, 1)',
		                'rgba(75, 192, 192, 1)',
		                'rgba(153, 102, 255, 1)',
		                'rgba(255, 159, 64, 1)'
		            ],
		            borderWidth: 1
		        }]
		    },
		    options: {
		        scales: {
		            yAxes: [{
		                ticks: {
		                    beginAtZero:true
		                }
		            }]
		        }
		    }
		});
	</script>
</body>
</html>
